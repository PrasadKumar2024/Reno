"""
Audio utilities for Twilio ↔ Google Cloud conversion
"""
import base64
import audioop
import logging

logger = logging.getLogger(__name__)

# Language to Google TTS voice mapping (Natural WaveNet/Neural2 voices)
LANGUAGE_VOICE_MAP = {
    "en-US": {"name": "en-US-Neural2-A", "gender": "FEMALE"},
    "en-IN": {"name": "en-IN-Neural2-C", "gender": "FEMALE"},  # Indian English
    "hi-IN": {"name": "hi-IN-Neural2-A", "gender": "FEMALE"},  # Hindi
    "te-IN": {"name": "te-IN-Standard-A", "gender": "FEMALE"}, # Telugu
    "ta-IN": {"name": "ta-IN-Wavenet-A", "gender": "FEMALE"},  # Tamil
    "bn-IN": {"name": "bn-IN-Wavenet-A", "gender": "FEMALE"},  # Bengali
    "ml-IN": {"name": "ml-IN-Wavenet-A", "gender": "FEMALE"},  # Malayalam
    "kn-IN": {"name": "kn-IN-Wavenet-A", "gender": "FEMALE"},  # Kannada
    "gu-IN": {"name": "gu-IN-Wavenet-A", "gender": "FEMALE"},  # Gujarati
    "mr-IN": {"name": "mr-IN-Wavenet-A", "gender": "FEMALE"},  # Marathi
}

# Language fallback for base language codes
LANGUAGE_FALLBACK = {
    "en": "en-IN",
    "hi": "hi-IN",
    "te": "te-IN",
    "ta": "ta-IN",
    "bn": "bn-IN",
    "ml": "ml-IN",
    "kn": "kn-IN",
    "gu": "gu-IN",
    "mr": "mr-IN",
}

def get_best_voice(language_code: str) -> tuple:
    """
    Returns (language_code, voice_name, gender) for TTS.
    Falls back intelligently if exact match not found.
    """
    # Direct match
    if language_code in LANGUAGE_VOICE_MAP:
        voice = LANGUAGE_VOICE_MAP[language_code]
        return (language_code, voice["name"], voice["gender"])
    
    # Try base language (e.g., "en" from "en-GB")
    base_lang = language_code.split("-")[0] if "-" in language_code else language_code
    if base_lang in LANGUAGE_FALLBACK:
        fallback_lang = LANGUAGE_FALLBACK[base_lang]
        voice = LANGUAGE_VOICE_MAP[fallback_lang]
        return (fallback_lang, voice["name"], voice["gender"])
    
    # Ultimate fallback: Indian English
    voice = LANGUAGE_VOICE_MAP["en-IN"]
    logger.warning(f"No voice found for {language_code}, using en-IN")
    return ("en-IN", voice["name"], voice["gender"])

def twilio_payload_to_linear16(mu_law_b64: str) -> bytes:
    """
    Twilio sends base64 of audio/x-mulaw @8000Hz.
    Convert mu-law bytes → LINEAR16 (16-bit little-endian PCM).
    """
    try:
        mu_bytes = base64.b64decode(mu_law_b64)
        # mu-law to 16-bit little-endian (width=2)
        linear16 = audioop.ulaw2lin(mu_bytes, 2)
        return linear16
    except Exception as e:
        logger.error(f"Audio conversion error: {e}")
        return b""

def linear16_to_twilio_mulaw(linear16_bytes: bytes) -> str:
    """
    Convert LINEAR16 (16-bit) → mu-law 8-bit → base64 for Twilio.
    """
    try:
        mulaw = audioop.lin2ulaw(linear16_bytes, 2)
        return base64.b64encode(mulaw).decode("ascii")
    except Exception as e:
        logger.error(f"Audio encoding error: {e}")
        return ""
